name: deploy on aws ec2
on:
    # Deploy only when pushed directly to the master
    push:
        branches:
            - master
jobs:
    deploy:
        name: deploy
        runs-on: ubuntu-latest
        steps:
            - name: ssh to AWS EC2 and do manual deploy
              uses: appleboy/ssh-action@master
              with:
                  host: ${{ secrets.AWS_HOST }}
                  username: ${{ secrets.AWS_USERNAME }}
                  key: ${{ secrets.AWS_KEY }}
                  script: |
                      cd personal-website &&
                      git checkout master &&
                      git pull &&
                      sudo docker-compose build &&
                      sudo docker-compose down &&
                      sudo docker-compose up -d
                      # cleanup
                      # sudo docker images | grep '<none>' | sed -E 's/\s+/ /g' | cut -d ' ' -f 3 | xargs -I {} sudo docker rmi {} -f

